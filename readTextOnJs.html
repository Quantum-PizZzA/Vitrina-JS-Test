<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Чтение файла</title>
  </head>

  <body>
    <input type="file" id="file" >
    <button id="read">Чтение файла</button>
    <p id="demo">Сумма</p>

    <div class="container">

      <textarea type="text" id="one"> </textarea>
      <button id="Push">Push</button>
  </div>

    </div>
    </form>

    <script>
      document.querySelector("#read").addEventListener("click", function Text() {
        let file = document.getElementById("file").files[0];

        let reader = new FileReader();

        reader.readAsText(file);

        reader.onload = function () { body(reader.result.split("\n"));
        console.log(`Добавленный файл: \n${reader.result}`);
          // const massString = reader.result.split("\n");
        }
        

      });

        document.querySelector("#Push").onclick = () => {
        console.log(`Добавленный файл: \n${document.querySelector("#one").value.split("\n")}`);
        body(document.querySelector("#one").value.split("\n"))

      };

      function body(massString) {

          let sum = 0;
          let exactNumbers = 0;
          let massNumber = [];
          let massEnter = [];

          // Сумма
          for (
            let i = 0;
            i < massString.length.toString() &&
            massString[i] != "NaN" &&
            massString[i] != "\r" &&
            massString[i] != "";
            i++, exactNumbers++
          ) {
            sum = sum + Number(massString[i]);
            massNumber[i] = Number(massString[i]);
            massEnter[i] = massNumber[i];
          }

          

        

          // Функция сортировки
          function sIncrease(i, ii) {
            // По возрастанию
            if (i > ii) return 1;
            else if (i < ii) return -1;
            else return 0;
          }
          massNumber.sort(sIncrease);

          // Гененраци hashCode
          function hashCodeGen(str) {
            return str
              .split("")
              .reduce(
                (prevHash, currVal) =>
                  ((prevHash << 5) - prevHash + currVal.charCodeAt(0)) | 0,
                0
              );
          }

          //построение Hash
          Hash = "" + exactNumbers;

          for (let i = 0; i < massNumber.sort(sIncrease).length; i++) {
            Hash = Hash + massNumber.sort(sIncrease)[i];
          }

          hashCode = Math.abs(hashCodeGen(Hash));

          // console.log(`Добавленный файл: \n${reader.result}`);
          console.log("Сумма = ", sum);
          // console.log("Матрица massString = ", massString);
          // console.log("Матрица massNumber = ", massNumber);
          // console.log("Сортировка = ", massNumber.sort(sIncrease));
          console.log("Точное количество чисел = ", exactNumbers);
          console.log(`Штрих код от [${Hash}] = ${hashCodeGen(Hash)}`);
          document.getElementById("demo").innerHTML = sum;

          //проход по localStorage

          dbchek = "нет данных";
          console.log(dbchek);

          for (let i = 0; i < localStorage.length; i++) {
            let key = localStorage.key(i);

            if (key == hashCodeGen(Hash) && dbchek == "нет данных") {
              console.log(`! ${i} ключ найден ${key} = ${hashCodeGen(Hash)}`);
              dbchek = "данные уже в базе";
            }
          }

          console.log(dbchek);
          if (dbchek == "нет данных") {
            console.log(`запись в localStorage = ${hashCodeGen(Hash)}`);
            //запись в localStorage
            localStorage.setItem(hashCodeGen(Hash), massEnter);
            localStorage.setItem(-hashCodeGen(Hash), sum);
          }
        };

        // reader.onerror = function () {
        //   console.log(reader.error);
        // };
      
    </script>
  </body>
</html>
